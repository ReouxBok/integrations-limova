import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const projectRoot = path.join(__dirname, "..");
const componentsDir = path.join(projectRoot, "components");
const outputFile = path.join(projectRoot, "src", "lib", "generated-actions-map.ts");

const header = `// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// Generated by scripts/generate-actions-map.mjs
// This file maps each Pipedream integration slug to its available actions and sources

export const integrationActionsMap: Record<string, { actions: string[]; sources: string[] }> =
`;

function getSubfolders(dirPath) {
  try {
    const entries = fs.readdirSync(dirPath, { withFileTypes: true });
    return entries
      .filter((e) => e.isDirectory())
      .map((e) => e.name)
      .sort();
  } catch {
    return [];
  }
}

function generateMap() {
  const map = {};

  const rootEntries = fs.readdirSync(componentsDir, { withFileTypes: true });

  for (const entry of rootEntries) {
    if (!entry.isDirectory()) continue;
    const slug = entry.name; // e.g. "gmail", "_1crm", "openai", ...

    const actionsDir = path.join(componentsDir, slug, "actions");
    const sourcesDir = path.join(componentsDir, slug, "sources");

    const actions = getSubfolders(actionsDir);
    const sources = getSubfolders(sourcesDir);

    // M√™me si une int√©gration n'a que des sources ou que des actions, on la garde
    map[slug] = {
      actions,
      sources,
    };
  }

  return map;
}

function main() {
  console.log("üîç Scan du dossier components/ pour g√©n√©rer la carte des actions...");

  if (!fs.existsSync(componentsDir)) {
    console.error(`‚ùå Dossier components introuvable: ${componentsDir}`);
    process.exit(1);
  }

  const map = generateMap();

  const json = JSON.stringify(map, null, 2);
  const content = `${header}${json} as const;\n`;

  fs.mkdirSync(path.dirname(outputFile), { recursive: true });
  fs.writeFileSync(outputFile, content, "utf-8");

  const totalIntegrations = Object.keys(map).length;
  console.log(`‚úÖ Carte g√©n√©r√©e pour ${totalIntegrations} int√©grations.`);
  console.log(`üìÑ Fichier √©crit: ${outputFile}`);
}

main();


